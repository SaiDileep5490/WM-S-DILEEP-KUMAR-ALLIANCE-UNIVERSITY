#include "stm32l4xx_hal.h"
#include "ultrasonic.h"
#include "filter.h"
#include "fault.h"
#include "fill_level.h"
#include "status.h"
#include "packet.h"
#include <stdio.h>

int main(void)
{
    HAL_Init();
    SystemClock_Config(); // CubeMX generated
    MX_GPIO_Init();
    MX_TIM2_Init();  // Ultrasonic echo input
    MX_TIM6_Init();  // microsecond delay
    MX_USART2_UART_Init(); // Debug print

    char lora_payload[32];
    const char BIN_ID[] = "BIN042";
    float battery_voltage = 3.4f; // placeholder

    float samples[FILTER_SIZE];
    float filtered_distance;
    float prev_distance = 0;
    SensorStatus_t sensor_status;
    float fill_percentage;
    BinStatus_t bin_status;

    while (1)
    {
        /* Step 1: Collect & Filter */
        for (int i = 0; i < FILTER_SIZE; i++)
        {
            samples[i] = Ultrasonic_ReadDistance();
            HAL_Delay(60);
        }
        filtered_distance = Median_Filter(samples);

        /* Step 2: Fault Handling */
        sensor_status = Fault_Check(filtered_distance, prev_distance);

        if (sensor_status == SENSOR_OK)
        {
            prev_distance = filtered_distance;

            /* Step 3: Fill Calculation */
            fill_percentage = Calculate_Fill_Percentage(filtered_distance);

            /* Step 4: Status Classification */
            bin_status = Get_Bin_Status(fill_percentage);
        }
        else
        {
            bin_status = BIN_FAULT;
        }

        /* Step 5: Packet Formation */
        Build_Packet(lora_payload, BIN_ID, bin_status, fill_percentage, battery_voltage);

        /* Step 6: Send payload via LoRaWAN */
        // send_lorawan_packet(lora_payload); // integrate LMIC here

        /* Debug output */
        printf("Payload: %s\r\n", lora_payload);

        /* Step 7: Enter low-power sleep */
        HAL_PWR_EnterSLEEPMode(PWR_MAINREGULATOR_ON, PWR_SLEEPENTRY_WFI);
    }
}
