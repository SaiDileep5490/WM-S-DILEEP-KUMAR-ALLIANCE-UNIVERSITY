from flask import Flask, render_template
import folium
from folium.plugins import MarkerCluster
import paho.mqtt.client as mqtt
import threading
import json
from geopy.distance import geodesic

app = Flask(__name__)

# Store bin data
bins = {}  # bin_id -> {'lat':..., 'lng':..., 'status':..., 'fill':..., 'battery':...}

# MQTT settings
MQTT_BROKER = "broker.hivemq.com"
MQTT_PORT = 1883
MQTT_TOPIC = "smartbins/+/up"

# MQTT Callbacks
def on_connect(client, userdata, flags, rc):
    print("Connected to MQTT broker")
    client.subscribe(MQTT_TOPIC)

def on_message(client, userdata, msg):
    payload = json.loads(msg.payload.decode())
    bins[payload['bin_id']] = payload
    print(f"Updated: {payload['bin_id']}")

# Start MQTT client in separate thread
def mqtt_thread():
    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message
    client.connect(MQTT_BROKER, MQTT_PORT, 60)
    client.loop_forever()

threading.Thread(target=mqtt_thread).start()

# Route optimization: Nearest Neighbor for RED + YELLOW bins
def optimize_route():
    route_bins = [b for b in bins.values() if b['status'] in ['R','Y']]
    if not route_bins:
        return []
    # Start with first RED bin if exists
    reds = [b for b in route_bins if b['status']=='R']
    current = reds[0] if reds else route_bins[0]
    route = [current]
    remaining = [b for b in route_bins if b!=current]

    while remaining:
        nearest = min(remaining, key=lambda b: geodesic(
            (current['lat'], current['lng']), (b['lat'], b['lng'])
        ).meters)
        route.append(nearest)
        remaining.remove(nearest)
        current = nearest
    return route

# Flask route
@app.route("/")
def index():
    # Center map
    map_center = (12.9716,77.5946)
    m = folium.Map(location=map_center, zoom_start=12)
    marker_cluster = MarkerCluster().add_to(m)

    # Add markers
    for b in bins.values():
        color = 'green' if b['status']=='G' else 'yellow' if b['status']=='Y' else 'red'
        folium.CircleMarker(
            location=(b['lat'], b['lng']),
            radius=8,
            color=color,
            fill=True,
            fill_color=color,
            popup=f"Bin:{b['bin_id']}<br>Status:{b['status']}<br>Fill:{b['fill']}%<br>Battery:{b['battery']}V"
        ).add_to(marker_cluster)

    # Draw optimized route
    route = optimize_route()
    if route:
        route_coords = [(b['lat'],b['lng']) for b in route]
        folium.PolyLine(route_coords, color='blue', weight=3, opacity=0.7).add_to(m)

    return m._repr_html_()

if __name__=="__main__":
    app.run(debug=True)
